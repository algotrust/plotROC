---
title: "ROC Curves using ggplot2 + gridSVG + d3.js"
author: "Michael Sachs"
date: "`r Sys.Date()`"
output: 
  html_document
---

<style type = "text/css">
header {

width: 160px;
position: fixed;
float: left;
margin-left: -160px;

}
</style>

<header>
<a href="http://github.com/sachsmc/plotROC">View on github</a>
</header>

# Installation

This package is not currently on CRAN. To install, use `devtools`

```{r install, eval = FALSE}
devtools::install_github("sachsmc/plotROC")
```

# Interactive SVG ROC Curves
After installing, run the interactive Shiny app
```{r shiny, eval = FALSE}
shiny_plotROC()
```


## Hover over to view the cutoff values

```{r test-a, fig.keep='none', results = 'asis', echo = TRUE, fig.width=6, fig.height=6}
library(plotROC)
D.ex <- rbinom(100, 1, .5)

rocdata <- calculate_roc(rnorm(100, mean = D.ex), D.ex)

myrocplot <- ggroc(rocdata, label = "Example")

cat(export_interactive_roc(myrocplot, cutoffs = rocdata$c, font.size = "12px", prefix = "a"))
```


## Click to view confidence region

```{r test-a-ci, fig.keep='none', results = 'asis', echo = TRUE, fig.width=6, fig.height=6}

rocdata <- calculate_roc(rnorm(100, mean = D.ex), D.ex, CI = TRUE)

myrocplot <- ggroc(rocdata, label = "Example", ci = TRUE)

cat(export_interactive_roc(myrocplot, cutoffs = rocdata$c, font.size = "12px", prefix = "aci"))
```

That is an svg element. Try zooming in!

## Generate an interactive plot to view in Rstudio viewer or web browser

```{r inter, eval = FALSE}
plot_interactive_roc(rocdata)
```


# Themes and annotations

```{r test-b, fig.keep='none', results = 'asis', echo = TRUE, fig.width=6, fig.height=6}
library(ggthemes)
myplot2 <- myrocplot + theme_igray()

cat(export_interactive_roc(myplot2, cutoffs = rocdata$c, font.size = "12px", prefix = "b"))
```


# For using in print

```{r print, fig.width = 6, fig.height = 6}
plot_journal_roc(myrocplot, rocdata)
```

# Confidence intervals for print

```{r printci, fig.width = 6, fig.height = 6}
plot_journal_roc(myrocplot, rocdata, n.cuts = 10, ci.at = c(-.5, .5, 2.1))
```

# Themes work in print too, but I don't recommend colors

```{r print2, fig.width = 6, fig.height = 6}
plot_journal_roc(myrocplot, rocdata) + theme_igray() + ggtitle("My awesome new biomarker")
```


# Multiple ROC Curves

```{r multi, fig.width = 6, fig.height = 6}
D.ex <- rbinom(100, 1, .5)

fakedata <- data.frame(M1 = rnorm(100, mean = D.ex), M2 = rnorm(100, mean = D.ex, sd = .4), M3 = runif(100), D = D.ex)
datalist <- calculate_multi_roc(fakedata, c("M1", "M2", "M3"), "D")

rocplot <- multi_ggroc(datalist)
plot_journal_roc(rocplot, datalist)
```

```{r test-multi, fig.keep='none', results = 'asis', echo = TRUE, fig.width=6, fig.height=6}
cat(export_interactive_roc(rocplot, cutoffs = lapply(datalist, function(d) d$c), font.size = "12px", prefix = "bmulti"))
```

## Labels
```{r multi2, fig.width = 6, fig.height = 6}
D.ex <- rbinom(100, 1, .5)

fakedata <- data.frame(M1 = rnorm(100, mean = D.ex), M2 = rnorm(100, mean = D.ex, sd = .4), M3 = runif(100), D = D.ex)
datalist <- calculate_multi_roc(fakedata, c("M1", "M2", "M3"), "D")

rocplot <- multi_ggroc(datalist, label = c("M1", "M2", "M3"))
plot_journal_roc(rocplot, datalist)
```



# Acknowledgements

This package would not be possible without the following:

  - [ggplot2](http://ggplot2.org/)
  - [gridSVG](http://sjp.co.nz/projects/gridsvg/)
  - [d3.js](http://d3js.org)
  

# Just for fun, transitions


```{r test-d, fig.keep='none', results = 'asis', echo = TRUE, fig.width=10, fig.height=6}
library(ggplot2)
library(ggthemes)
library(gridSVG)
library(grid)

p <- ggplot(mtcars, aes(x = mpg, y = hp)) + geom_point(size = 5) + 
  scale_y_continuous(limits = c(-50, 500)) + scale_x_continuous(limits = c(0, 50))
p

grid.force()

objnames <- grid::grid.ls(print = FALSE)$name
ptns <- grep("geom_point.points", objnames, value = TRUE)[1]

grid.garnish(ptns, tip = paste(mtcars$cyl), group = FALSE, global = TRUE, grep = TRUE)

ptns <- paste0("cars", ptns)

grid.export(NULL, prefix = "cars")$svg
```

<button id="moveme">Move the points!</button>

<script>

function randCol() {

    return "rgb(" + Math.round(Math.random()*255) + ", " + Math.round(Math.random()*255) + ", " + Math.round(Math.random()*255) + ")";

} 

d3.select("#moveme").on("click", function(){

  d3.selectAll("[id^='`r ptns`.1.']")
    .transition().duration(500)
    .attr("fill", randCol())
    .attr("y", function(d){ return Number(d3.select(this).attr("y")) + 50 * (Math.random() - .5); })
    .attr("x", function(d){ return Number(d3.select(this).attr("x")) + 25 * (Math.random() - .5); });
  
});


</script>





